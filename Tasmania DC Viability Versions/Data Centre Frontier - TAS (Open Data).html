<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Data Centre Frontier — Tasmania (Open Data)</title>

  <!-- CSS for MapLibre & Draw -->
  <link href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css" rel="stylesheet" />
  <link href="https://unpkg.com/@mapbox/mapbox-gl-draw@1.5.0/dist/mapbox-gl-draw.css" rel="stylesheet" />

  <!-- Tailwind (for quick UI) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    html, body { height:100%; margin:0; background:#0b1220; }
    #map { position:absolute; inset:0; }
    .btn {
      padding:0.5rem 0.75rem; border-radius:0.75rem; font-size:0.875rem; font-weight:600;
      background:#1f2a44; color:#e6edf6; border:1px solid #2c3a5e; transition:filter .15s ease;
    }
    .btn:hover { filter:brightness(1.1); }
    .btn.active { outline:2px solid #6ea8fe; background:#24365f; }
    .panel { backdrop-filter: blur(6px); background: rgba(15,23,42,0.75); border:1px solid rgba(71,85,105,.6); border-radius:1rem; color:#e6edf6; }
    .legend-swatch { width:14px; height:14px; border-radius:3px; display:inline-block; vertical-align:middle; margin-right:8px; }
    .legend-line { width:18px; height:3px; display:inline-block; vertical-align:middle; margin-right:8px; border-radius:2px; }
    .toast { position:fixed; bottom:18px; left:50%; transform:translateX(-50%); }
  </style>
</head>
<body>
  <div id="map"></div>

  <!-- Controls -->
  <div class="panel fixed top-3 left-3 p-3 space-y-2 w-[360px]">
    <h1 class="text-lg font-semibold">Data Centre Frontier — TAS (Open Data)</h1>
    <p class="text-slate-300 text-xs leading-snug">
      Draw a polygon for a prospective site. We score it using live public datasets for Tasmania (grid, protected areas, water).
      Nothing leaves your browser.
    </p>
    <div class="flex gap-2">
      <button id="draw-poly" class="btn">Draw polygon</button>
      <button id="btn-clear" class="btn">Clear</button>
    </div>
    <div id="status" class="text-[11px] text-slate-300"></div>
  </div>

  <!-- Legend -->
  <div class="panel fixed top-3 right-3 p-3 w-[280px]">
    <h2 class="text-sm font-semibold mb-2">Key</h2>
    <ul class="space-y-2 text-sm">
      <li class="flex items-center justify-between gap-3">
        <span class="text-slate-200">Your polygon</span>
        <span>
          <span class="legend-swatch" style="background:#22d3ee;opacity:0.35;border:1px solid #06b6d4;"></span>
          <span class="legend-line" style="background:#06b6d4;"></span>
        </span>
      </li>
      <li class="flex items-center justify-between gap-3">
        <span class="text-slate-200">HV transmission (≥220 kV)</span>
        <span class="legend-line" style="background:#f97316;"></span>
      </li>
      <li class="flex items-center justify-between gap-3">
        <span class="text-slate-200">Transmission substation</span>
        <span class="legend-swatch" style="background:#f43f5e;"></span>
      </li>
      <li class="flex items-center justify-between gap-3">
        <span class="text-slate-200">Protected area (CAPAD)</span>
        <span class="legend-swatch" style="background:#84cc16; opacity:0.35; border:1px solid #65a30d;"></span>
      </li>
      <li class="flex items-center justify-between gap-3">
        <span class="text-slate-200">Water storage</span>
        <span class="legend-swatch" style="background:#93c5fd; border:1px solid #60a5fa;"></span>
      </li>
      <li class="flex items-center justify-between gap-3">
        <span class="text-slate-200">Outside Tasmania (dimmed)</span>
        <span class="legend-swatch" style="background:#0b1220; border:1px dashed #475569;"></span>
      </li>
    </ul>
    <div class="mt-3 text-[11px] text-slate-400 leading-snug">
      Data sources: GA National Electricity Infrastructure, DCCEEW CAPAD 2024, BoM Australia Water Storages.
    </div>
  </div>

  <!-- Results -->
  <div class="panel fixed bottom-3 left-1/2 -translate-x-1/2 w-[860px] p-3">
    <div class="flex items-center justify-between">
      <h3 class="text-base font-semibold">Viability</h3>
      <div id="confidence" class="text-xs text-slate-300"></div>
    </div>
    <div class="mt-2 grid grid-cols-3 gap-3">
      <div class="p-3 rounded-xl bg-slate-800/60 border border-slate-700">
        <div class="text-slate-300 text-xs">Overall score</div>
        <div id="score" class="text-3xl font-bold">—</div>
      </div>
      <div class="p-3 rounded-xl bg-slate-800/60 border border-slate-700">
        <div class="text-slate-300 text-xs">Grid</div>
        <div id="gridScore" class="text-xl font-semibold">—</div>
        <div id="gridDesc" class="text-[11px] text-slate-400 leading-snug mt-1"></div>
      </div>
      <div class="p-3 rounded-xl bg-slate-800/60 border border-slate-700">
        <div class="text-slate-300 text-xs">Hazards (protected)</div>
        <div id="hazScore" class="text-xl font-semibold">—</div>
        <div id="hazDesc" class="text-[11px] text-slate-400 leading-snug mt-1"></div>
      </div>
      <div class="p-3 rounded-xl bg-slate-800/60 border border-slate-700">
        <div class="text-slate-300 text-xs">Water</div>
        <div id="waterScore" class="text-xl font-semibold">—</div>
        <div id="waterDesc" class="text-[11px] text-slate-400 leading-snug mt-1"></div>
      </div>
      <div class="col-span-3">
        <table class="w-full text-sm border-separate border-spacing-y-1">
          <thead class="text-slate-300 text-xs">
            <tr>
              <th class="text-left font-medium">Factor</th>
              <th class="text-left font-medium">Measured</th>
              <th class="text-left font-medium">Subscore</th>
              <th class="text-left font-medium">Weight</th>
              <th class="text-left font-medium">Notes</th>
            </tr>
          </thead>
          <tbody id="drivers"></tbody>
        </table>
      </div>
    </div>
  </div>

  <div id="toast" class="toast hidden panel px-4 py-2 text-sm"></div>

  <script>
    // ---------- Robust library loader with fallbacks ----------
    function loadScript(url){ return new Promise((res, rej)=>{ const s=document.createElement('script'); s.src=url; s.async=true; s.onload=res; s.onerror=()=>rej(new Error('Failed to load '+url)); document.head.appendChild(s); }); }
    async function ensureLib(globalName, urls){ if(window[globalName]) return; for(const u of urls){ try{ await loadScript(u); if(window[globalName]) return; }catch(e){} } throw new Error('Missing '+globalName); }

    // Pick OSM tile server (primary or HOT fallback)
    function pickTileUrl(cb){
      const primary='https://tile.openstreetmap.org/{z}/{x}/{y}.png';
      const fallback='https://tile.openstreetmap.fr/hot/{z}/{x}/{y}.png';
      const test=primary.replace('{z}','6').replace('{x}','57').replace('{y}','37');
      const img=new Image(); img.referrerPolicy='no-referrer';
      img.onload=()=>cb(primary); img.onerror=()=>cb(fallback); img.src=test;
    }

    // ---------- Constants ----------
    const TAS_BOUNDS = [[143.8, -43.8],[148.7, -39.5]]; // loose box for view
    const TAS_ENVELOPE_4326 = { xmin: 143.8, ymin: -43.8, xmax: 148.7, ymax: -39.5, spatialReference: { wkid: 4326 } };

    const ENDPOINTS = {
      GA_NEI_LINES: "https://services.ga.gov.au/gis/rest/services/National_Electricity_Infrastructure/MapServer/2",
      GA_NEI_SUBS:  "https://services.ga.gov.au/gis/rest/services/National_Electricity_Infrastructure/MapServer/0",
      CAPAD_FS:     "https://gis.environment.gov.au/gispubmap/rest/services/ogc_services/CAPAD/FeatureServer/0",
      BOM_WSPOLY:   "https://hosting.wsapi.cloud.bom.gov.au/arcgis/rest/services/Australia_Water_Storages/MapServer/1"
    };

    function qs(obj){ return new URLSearchParams(obj).toString(); }
    async function fetchGeoJSON(base, params, label){
      const url = base + "/query?" + qs(params);
      try{
        const r = await fetch(url);
        if(!r.ok) throw new Error(r.status + ' ' + r.statusText);
        return await r.json();
      }catch(e){
        warn('Could not load '+(label||'data')+': '+e.message);
        return { type:'FeatureCollection', features:[] };
      }
    }
    function warn(msg){
      const t=document.getElementById('toast');
      t.textContent=msg; t.classList.remove('hidden');
      setTimeout(()=>t.classList.add('hidden'), 4000);
      console.warn(msg);
    }

    // ---------- Map & Draw ----------
    let map, Draw, gjLines={type:'FeatureCollection',features:[]}, gjSubs={type:'FeatureCollection',features:[]}, gjCapad={type:'FeatureCollection',features:[]}, gjWater={type:'FeatureCollection',features:[]};

    async function start(tileUrl){
      // Build raster OSM style for reliability
      const style = { version:8, sources:{ osm:{ type:'raster', tiles:[tileUrl], tileSize:256, attribution:'© OpenStreetMap'} }, layers:[{ id:'osm', type:'raster', source:'osm'}] };

      map = new maplibregl.Map({ container:'map', style, center:[146.9,-41.6], zoom:6, maxBounds:TAS_BOUNDS });
      map.addControl(new maplibregl.NavigationControl(), 'bottom-right');

      window.mapboxgl = maplibregl; // MapboxDraw expects mapboxgl global
      Draw = new MapboxDraw({
        displayControlsDefault:false,
        controls:{ polygon:false, trash:false },
        styles:[
          { id:'gl-draw-polygon-fill', type:'fill', filter:['all',['==','$type','Polygon'],['!=','mode','static']], paint:{ 'fill-color':'#22d3ee','fill-outline-color':'#06b6d4','fill-opacity':0.35 } },
          { id:'gl-draw-polygon-stroke-active', type:'line', filter:['all',['==','$type','Polygon'],['!=','mode','static']], paint:{ 'line-color':'#06b6d4','line-width':4 } },
          { id:'gl-draw-polygon-and-line-vertex-halo-active', type:'circle', filter:['all',['==','meta','vertex'],['==','$type','Point'],['!=','mode','static']], paint:{ 'circle-radius':5,'circle-color':'#0ea5e9' } }
        ]
      });
      map.addControl(Draw);

      const bDraw=document.getElementById('draw-poly'); const bClear=document.getElementById('btn-clear');
      function setActive(btn,on){ btn.classList.toggle('active', !!on); }

      bDraw.onclick=()=>{ setActive(bDraw,true); map.doubleClickZoom.disable(); Draw.changeMode('draw_polygon'); };
      bClear.onclick=()=>{ Draw.deleteAll(); setActive(bDraw,false); map.doubleClickZoom.enable(); resetResults(); };

      map.on('draw.modechange', e=>{ const a=e.mode==='draw_polygon'; setActive(bDraw,a); if(!a) map.doubleClickZoom.enable(); });
      map.on('draw.create', sampleNow);
      map.on('draw.update', sampleNow);

      map.on('load', async ()=>{
        document.getElementById('status').textContent='Loading open datasets for TAS…';

        // Dim outside TAS: big polygon with a hole
        const world=[[-180,-85],[180,-85],[180,85],[-180,85],[-180,-85]];
        const tas=[[TAS_ENVELOPE_4326.xmin,TAS_ENVELOPE_4326.ymin],[TAS_ENVELOPE_4326.xmax,TAS_ENVELOPE_4326.ymin],[TAS_ENVELOPE_4326.xmax,TAS_ENVELOPE_4326.ymax],[TAS_ENVELOPE_4326.xmin,TAS_ENVELOPE_4326.ymax],[TAS_ENVELOPE_4326.xmin,TAS_ENVELOPE_4326.ymin]];
        const mask={ type:'Feature', geometry:{ type:'Polygon', coordinates:[world, tas] } };
        map.addSource('mask', { type:'geojson', data:mask });
        map.addLayer({ id:'mask', type:'fill', source:'mask', paint:{ 'fill-color':'#0b1220','fill-opacity':0.45 } }, 'osm');

        // Load live layers
        gjLines = await fetchGeoJSON(ENDPOINTS.GA_NEI_LINES, {
          where: "(capacitykv >= 220) AND (state = 'Tasmania')",
          outFields: "capacitykv,name,state",
          returnGeometry: true, outSR: 4326, f: "geojson"
        }, 'GA transmission lines');

        gjSubs = await fetchGeoJSON(ENDPOINTS.GA_NEI_SUBS, {
          where: "state = 'Tasmania'",
          outFields: "name,voltagekv,state",
          returnGeometry: true, outSR: 4326, f: "geojson"
        }, 'GA substations');

        gjCapad = await fetchGeoJSON(ENDPOINTS.CAPAD_FS, {
          where: "ENVIRON = 'Terrestrial'",
          geometry: JSON.stringify(TAS_ENVELOPE_4326),
          geometryType: "esriGeometryEnvelope", inSR: 4326, spatialRel: "esriSpatialRelIntersects",
          outFields: "NAME,TYPE,IUCN,STATE", returnGeometry: true, outSR: 4326, f: "geojson"
        }, 'CAPAD 2024');

        gjWater = await fetchGeoJSON(ENDPOINTS.BOM_WSPOLY, {
          where: "1=1",
          geometry: JSON.stringify(TAS_ENVELOPE_4326),
          geometryType: "esriGeometryEnvelope", inSR: 4326, spatialRel: "esriSpatialRelIntersects",
          outFields: "name,perennial,ahgfftype", returnGeometry: true, outSR: 4326, f: "geojson"
        }, 'BoM water storages');

        // Add sources & layers
        map.addSource('capad', { type:'geojson', data: gjCapad });
        map.addLayer({ id:'capad', type:'fill', source:'capad', paint:{ 'fill-color':'#84cc16','fill-opacity':0.35,'fill-outline-color':'#65a30d' } });

        map.addSource('lines', { type:'geojson', data: gjLines });
        map.addLayer({ id:'lines', type:'line', source:'lines', paint:{ 'line-color':'#f97316','line-width':3 } });

        map.addSource('subs', { type:'geojson', data: gjSubs });
        map.addLayer({ id:'subs', type:'circle', source:'subs', paint:{
          'circle-radius':['interpolate',['linear'],['coalesce',['get','voltagekv'],110],110,4,220,6,330,8,500,10],
          'circle-color':'#f43f5e', 'circle-stroke-color':'#fda4af','circle-stroke-width':1
        }});

        map.addSource('water', { type:'geojson', data: gjWater });
        map.addLayer({ id:'water', type:'fill', source:'water', paint:{ 'fill-color':'#93c5fd','fill-opacity':0.5,'fill-outline-color':'#60a5fa' } });

        map.fitBounds(TAS_BOUNDS, { padding: 30, duration: 600 });
        document.getElementById('status').textContent='Datasets loaded. Click "Draw polygon" to begin.';
      });
    }

    function resetResults(){
      ['score','gridScore','hazScore','waterScore','gridDesc','hazDesc','waterDesc','confidence'].forEach(id=>{
        const el=document.getElementById(id); el.textContent='—';
      });
      document.getElementById('drivers').innerHTML='';
    }

    // ---------- Scoring ----------
    function ramp01(x, good, bad){ if(x<=good) return 1; if(x>=bad) return 0; return (bad-x)/(bad-good); }
    function fmtKm(k){ return (k<1 ? (k*1000).toFixed(0)+' m' : k.toFixed(1)+' km'); }

    function nearestDistanceKm(poly, features, mode){
      if(!features || !features.features || !features.features.length) return Infinity;
      const center = turf.centerOfMass(poly);
      let best = Infinity;
      for(const f of features.features){
        let d = Infinity;
        if(mode==='line'){
          if(f.geometry.type==='LineString'){
            d = turf.pointToLineDistance(center, f, {units:'kilometers'});
          } else if(f.geometry.type==='MultiLineString'){
            for(const coords of f.geometry.coordinates){
              const seg = { type:'Feature', geometry:{ type:'LineString', coordinates:coords } };
              d = Math.min(d, turf.pointToLineDistance(center, seg, {units:'kilometers'}));
            }
          }
        } else if(mode==='point'){
          const p = f.geometry.type==='Point' ? f : turf.centerOfMass(f);
          d = turf.distance(center, p, {units:'kilometers'});
        } else if(mode==='polygon'){
          try{
            if(turf.booleanPointInPolygon(center, f)) d = 0;
            else {
              const line = turf.polygonToLine(f);
              d = turf.pointToLineDistance(center, line, {units:'kilometers'});
            }
          }catch(e){ d = Infinity; }
        }
        if(d<best) best = d;
      }
      return best;
    }

    function intersectsAny(poly, features){
      if(!features || !features.features) return false;
      for(const f of features.features){
        try{ if(turf.booleanIntersects(poly, f)) return true; }catch(e){}
      }
      return false;
    }

    function setDriverRow(name, measured, subscore, weight, notes=""){
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="py-1 pr-2">${name}</td>
        <td class="py-1 pr-2 text-slate-200">${measured}</td>
        <td class="py-1 pr-2">${Math.round(subscore*100)}</td>
        <td class="py-1 pr-2">${Math.round(weight*100)}%</td>
        <td class="py-1 pr-2 text-slate-400">${notes}</td>`;
      document.getElementById('drivers').appendChild(tr);
    }

    function sampleNow(){
      const fc=Draw.getAll();
      if(!fc || !fc.features.length){ warn('Draw a polygon first.'); return; }
      const poly=fc.features[0];
      document.getElementById('drivers').innerHTML='';

      // Distances (km)
      const dHV = nearestDistanceKm(poly, gjLines, 'line');
      const dSub = nearestDistanceKm(poly, gjSubs, 'point');
      const dWater = nearestDistanceKm(poly, gjWater, 'polygon');
      const inProtected = intersectsAny(poly, gjCapad);

      // Subscores
      const sHV = ramp01(dHV, 2, 25);
      const sSub = ramp01(dSub, 10, 60);
      const grid = 0.6*sHV + 0.4*sSub;
      const hazards = inProtected ? 0 : 1;
      const water = ramp01(dWater, 10, 80);

      // Weights (simple, open-data build)
      const W = { grid:0.6, hazards:0.2, water:0.2 };
      const score = 100*(W.grid*grid + W.hazards*hazards + W.water*water);

      // Write UI
      document.getElementById('gridScore').textContent = Math.round(grid*100);
      document.getElementById('hazScore').textContent = Math.round(hazards*100);
      document.getElementById('waterScore').textContent = Math.round(water*100);
      document.getElementById('score').textContent = Math.round(score);

      document.getElementById('gridDesc').textContent = `Nearest HV: ${isFinite(dHV)?fmtKm(dHV):'—'}; nearest substation: ${isFinite(dSub)?fmtKm(dSub):'—'}.`;
      document.getElementById('hazDesc').textContent = inProtected ? 'Inside a CAPAD protected area.' : 'No CAPAD overlap.';
      document.getElementById('waterDesc').textContent = isFinite(dWater) ? `Nearest storage: ${fmtKm(dWater)}.` : 'No storage in range.';

      setDriverRow('HV transmission proximity', isFinite(dHV)?fmtKm(dHV):'—', sHV, 0.6, 'GA National Electricity Infrastructure (≥220 kV)');
      setDriverRow('Substation proximity', isFinite(dSub)?fmtKm(dSub):'—', sSub, 0.4, 'GA National Electricity Infrastructure');
      setDriverRow('Protected area overlap', inProtected?'Yes':'No', hazards, 0.2, 'DCCEEW CAPAD 2024 (terrestrial)');
      setDriverRow('Water storage proximity', isFinite(dWater)?fmtKm(dWater):'—', water, 0.2, 'BoM Australia Water Storages');

      document.getElementById('confidence').textContent = 'Live public layers for TAS. Add-ons (telecom, slope, flood, bushfire, ports/airports) coming.';
    }

    // ---------- Bootstrap ----------
    (async function bootstrap(){
      try{
        await ensureLib('maplibregl', [
          'https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js',
          'https://cdnjs.cloudflare.com/ajax/libs/maplibre-gl/3.6.2/maplibre-gl.min.js'
        ]);
        await ensureLib('MapboxDraw', [
          'https://unpkg.com/@mapbox/mapbox-gl-draw@1.5.0/dist/mapbox-gl-draw.min.js',
          'https://cdnjs.cloudflare.com/ajax/libs/mapbox-gl-draw/1.5.0/mapbox-gl-draw.min.js'
        ]);
        await ensureLib('turf', [
          'https://unpkg.com/@turf/turf@6.5.0/turf.min.js',
          'https://cdnjs.cloudflare.com/ajax/libs/Turf.js/6.5.0/turf.min.js'
        ]);
        pickTileUrl((url)=> start(url));
      }catch(e){
        warn('Failed to load mapping libraries. Try allowing unpkg.com/cdnjs.cloudflare.com in your blocker.');
      }
    })();
  </script>

  <div class="fixed bottom-3 right-3 text-[11px] text-slate-400 bg-slate-900/70 border border-slate-700/60 rounded-md px-2 py-1">
    © GA, DCCEEW, BoM — CC BY 4.0 except where noted. This page loads data directly from their public services.
  </div>
</body>
</html>
